# Design

*2025-12-26*

`asker` requests input from the user. The motivation for it is to allow system
daemons to ask for user input.

An extra goal is to prevent unauthorised programs from asking for particular inputs.
For example, I may allow daemon `A` to ask for secret `S`. But then I install daemon
`B` which I don't want to request secrets. However, daemon `B` asks for secret
`S` in a way that appears to be a request from daemon `A`. I satisfy the request
and daemon `B` leaks my secret.

At startup `asker` knows all the inputs that can be requested. An input's name
is called a "key". An input can be requested by calling `asker KEY`. The Linux
permissions system is used to prevent unauthorised access. `asker KEY` may
only succeed when the process's user is a member of the `asker-key-{KEY}` group.

`/run/asker/` is owned by the `asker` user, and contains a directory for each key.
Each `/run/asker/{KEY}` belongs to the `asker-key-{KEY}` group, and has permissions `drwxrwxr-x`.
To request input, a program running as a user who belongs to `asker-key-{KEY}` creates
a Unix domain socket in `/run/asker/{KEY}` with permissions `----r---w-`.
The socket can only be read by members of `asker-key-{KEY}` (preventing unauthorised
access to the requested input), but it can be *written to* by anyone. This
allows the user (who shouldn't be a member of the key group) to provide the input.
Any program can write to this socket, so it's possible for "malicious" programs
to write garbage. I don't consider this a risk. The program that created the socket
does a blocking read. When it receives some input, it closes and deletes the
socket (TODO: what about concurrent requests?).

`asker-prompt` runs as a user service. It watches each `/runasker/{KEY}` directory for file creations
(allowed because these directories are readable by all). When a Unix domain
socket is created inside `/run/asker/{KEY}`, `asker-prompt` creates a window that
prompts for input. The user input is then written to the domain socket.

`/run/asker/{KEY}/garbage` is a special file that is also other-writeable.
When `asker-prompt` fails to connect to connect to `/run/asker/{KEY}/{NAME}`,
it appends `{NAME}\n` to `/run/asker/{KEY}/garbage`. Entries in that file are safe
for removal by a process that has write permissions on `/run/asker/{KEY}/`.

`/run/asker/{KEY}/description` is a special read-only file. It contains a trusted
description of the key, to be displayed by `asker-prompt` when the key is requested.
